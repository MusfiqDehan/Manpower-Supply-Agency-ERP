<form method="POST" action="{% url 'administration_app:user_change_password' user_id.id %}" class="UserPasswordEditionForm">
  {% csrf_token %}

  <div class="modal-header">
    <h5 class="modal-title">User Password Change Form({{ user_id.id }})</h5>
    <button class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
  </div>

  <div class="modal-body">
    <div class="row g-3 align-items-center">

      <div class="col-sm-12 col-md-12">
        <div class="form-floating password-container">
          <input class="form-control" type="password" name="new_password" required="" id="id_new_password" placeholder="New Password" required />
          <label for="id_new_password">New Password</label>
          <i class="toggle-password fas fa-eye" id="toggleNewPassword"></i>
        </div>
      </div>

      <div class="col-sm-12 col-md-12">
        <div class="form-floating password-container">
          <input class="form-control" type="password" name="confirm_password" required="" id="id_confirm_password" placeholder="Confirm Password" required />
          <label for="id_confirm_password">Confirm Password</label>
          <i class="toggle-password fas fa-eye" id="toggleConfirmPassword"></i>
        </div>
      </div>

      <span id="password-error" style="color: red;"></span>

      <div class="modal-footer">
        <div class="form-submit">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" id="loading" class="btn btn-primary" data-bs-save="modal">Submit</button>
        </div>
      </div>
    </div>
  </div>
</form>

<style>
  /* Disable default password eye button */
  input[type="password"]::-ms-reveal {
      display: none;
  }

  input[type="password"] {
      -webkit-text-security: disc;
  }

  .password-container {
      position: relative;
  }

  .toggle-password {
      position: absolute;
      top: 50%;
      right: 10px;
      transform: translateY(-50%);
      cursor: pointer;
      color: #888;
      display: none;
  }
</style>

<script>
  $(document).ready(function() {
    // Disable the submit button initially
    $('#loading').prop('disabled', true);

    // Function to check if passwords match
    function checkPasswordMatch() {
      var password = $('#id_new_password').val();
      var confirmPassword = $('#id_confirm_password').val();

      if (password === confirmPassword && password !== '' && confirmPassword !== '') {
        $('#loading').prop('disabled', false);
        $('#password-error').text('');
      } else {
        $('#loading').prop('disabled', true);
        $('#password-error').text('Passwords do not match!');
      }
    }

    // Trigger checkPasswordMatch on keyup in either password field
    $('#id_new_password, #id_confirm_password').keyup(checkPasswordMatch);

    // Function to toggle password visibility
    function setupPasswordToggle(passwordFieldId, toggleButtonId) {
      const passwordField = document.getElementById(passwordFieldId);
      const toggleButton = document.getElementById(toggleButtonId);

      passwordField.addEventListener('input', function () {
        if (this.value.length > 0) {
          toggleButton.style.display = 'block';
        } else {
          toggleButton.style.display = 'none';
        }
      });

      toggleButton.addEventListener('click', function () {
        const type = passwordField.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordField.setAttribute('type', type);

        this.classList.toggle('fa-eye');
        this.classList.toggle('fa-eye-slash');
      });
    }

    setupPasswordToggle('id_new_password', 'toggleNewPassword');
    setupPasswordToggle('id_confirm_password', 'toggleConfirmPassword');
  });
</script>